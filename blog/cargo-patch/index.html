<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Time For Crab ðŸ¦€</title>

      <!-- CSS -->
      <link rel="stylesheet" href="https://gatowololo.github.io/print.css" media="print">
      <link rel="stylesheet" href="https://gatowololo.github.io/poole.css">
      <link rel="stylesheet" href="https://gatowololo.github.io/hyde.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

      

      
      
    </head>

    <body class="theme-base-08 ">
        
            <div class="sidebar">
                <div class="container sidebar-sticky">
                    <div class="sidebar-about">
                        
                            <a href="https:&#x2F;&#x2F;gatowololo.github.io"><h1>Time For Crab ðŸ¦€</h1></a>
                            
                            <p class="lead">Rust: Taste like crab, fast like C.</p>
                            
                        
                    </div>

                    <ul class="sidebar-nav">
                        
                        
                        <li><a href="&#x2F;">About Me</a></li>
                        
                        <li><a href="&#x2F;resources&#x2F;aboutme&#x2F;omar_resume.pdf">CV</a></li>
                        
                        <li><a href="&#x2F;publications&#x2F;main">Publications</a></li>
                        
                        <li><a href="https:&#x2F;&#x2F;github.com&#x2F;gatoWololo">Github</a></li>
                        
                        <li><a href="&#x2F;blog&#x2F;main">Blog</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        

        <div class="content container">
          
<div class="post">
  <h1 class="post-title">Patching Cargo Dependencies</h1>
  <span class="post-date"> Last updated: 2020-02-03</span>
  <p><em>Recommened Rust Skill</em>: <strong>Intermediate</strong> <sup class="footnote-reference"><a href="#1">1</a></sup></p>
<h3 id="summary"><a class="zola-anchor" href="#summary" aria-label="Anchor link for: summary">ðŸ”—</a>Summary</h3>
<p>Here we cover Cargo's patch mechanism for temporarily changing and easily changing a dependency. We motivate it, show various examples, and point out edge-cases and footguns beyond what the Cargo book covers. I found the official documentation quite terse and took me a long time to handle some cases not mentioned in the documentation.</p>
<h3 id="motivation"><a class="zola-anchor" href="#motivation" aria-label="Anchor link for: motivation">ðŸ”—</a>Motivation</h3>
<p>Cargo does a great job at managing Rust dependencies and most of the time <em>it just works</em>. There will come a time when you might need to modify the code for a dependency. The Cargo Book's section on <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html">Overriding Dependencies</a> mentions several use cases. For example, your application relies on the <code>nix</code> crate but there is a feature you need that has not been added to the lastest cratio.io version<sup class="footnote-reference"><a href="#2">2</a></sup>. <code>nix</code>'s code is hosted on github and the lastest commit on master includes the bug fix, how can you use this github's version until the changes make it to the next version on crates.io?</p>
<h3 id="cargo-patch"><a class="zola-anchor" href="#cargo-patch" aria-label="Anchor link for: cargo-patch">ðŸ”—</a>Cargo Patch</h3>
<p>Cargo has a mechanism to handle these type of cases, Cargo patch. Patching subsumes the older mechanism <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html#the-replace-section">Cargo replace</a><sup class="footnote-reference"><a href="#3">3</a></sup>. You can find <a href="https://doc.rust-lang.org/cargo/reference/overriding-dependencies.html">the official documentation</a> on Cargo patch on the official Rust Book. Namely, Cargo patch allows you to temporarily<sup class="footnote-reference"><a href="#4">4</a></sup> use an alternative version of a crate dependency (we will call this <em>patched dependency</em>). This will be usually be a crates.io dependency specified in your <code>Cargo.toml</code> (the manifest):</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Your Cargo.toml
# ...

[dependencies]
nix = &quot;0.17&quot;
libc = &quot;0.2&quot;
# ...
</code></pre>
<p>These dependencies are automatically downloaded from crates.io when your project is built. We will also look at examples when not using crates.io. The patched dependency can be a local version or a github version (others are supported as well).</p>
<h3 id="patching-dependency-with-a-local-version"><a class="zola-anchor" href="#patching-dependency-with-a-local-version" aria-label="Anchor link for: patching-dependency-with-a-local-version">ðŸ”—</a>Patching Dependency With a Local Version</h3>
<p>For the simple case, patching a dependency is as simple as adding a <code>[patch]</code> section in your <code>Cargo.toml</code> file. Here we will be patching the great <code>Nix</code> crate:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Your Cargo.toml
# ...

[dependencies]
nix = &quot;0.17&quot;
libc = &quot;0.2&quot;

[patch.crates-io]
nix = { path = &quot;&#x2F;path&#x2F;to&#x2F;local&#x2F;version&#x2F;nix&quot; }
</code></pre>
<p>Even in the simplest case there are a few things to unpack. I had never seen the <code>.crate-io</code> or <code>{ path = .. }</code> syntax before. I just accept the syntax as-is. This syntax comes from the TOML file format. See here for a quick <a href="https://learnxinyminutes.com/docs/toml/">overview</a>. Depending on your specific need, your local version of nix must match the version
on the manifest or be higher.</p>
<p>Notice it is not enough to simply <code>git clone</code> the Nix source code from <a href="https://github.com/nix-rust/nix">github.com/nix-rust/nix</a> as this will pull the latest version on master. Some projects provide releases or tag commits corresponding to crate-io versions, but in general there is no easy way to find which commit belongs to the specific version. Event the <a href="https://github.com/JanLikar/cargo-clone/">cargo clone</a> subcommand <a href="https://github.com/JanLikar/cargo-clone/issues/17">seems to have problems</a> if you want an exact version. Cargo fetches the source code of all dependencies when building a package, so my current solution is to copy this downloaded version of the crate. My IDE tells me the source code for Nix is stored in <code>~/.cargo/registry/src/github.com-1ecc6299db9ec823/nix-0.17.0/</code><sup class="footnote-reference"><a href="#5">5</a></sup>. I am then free to modify this copy and <code>patch</code> to its location.</p>
<p>Patching with local versions is not very portable. If you push <code>my-crate</code> to GitHub so others may also work off your patch version, they must use exact path for this to work. A better approach is to use TODO</p>
<h4 id="cargo-update"><a class="zola-anchor" href="#cargo-update" aria-label="Anchor link for: cargo-update">ðŸ”—</a>Cargo Update</h4>
<h4 id="crab-sharp-edge-picking-the-correct-package-version"><a class="zola-anchor" href="#crab-sharp-edge-picking-the-correct-package-version" aria-label="Anchor link for: crab-sharp-edge-picking-the-correct-package-version">ðŸ”—</a>ðŸ¦€ Sharp Edge: Picking the Correct Package Version</h4>
<p>A dependency entry in the <code>Cargo.toml</code> file (e.g. <code>nix = &quot;0.17&quot;</code>) is generally not enough to tell what version of a package cargo is using as Cargo has some choice when picking version. See <a href="https://doc.rust-lang.org/cargo/reference/resolver.html">Dependency Resolution</a> for more information. Instead, consult the <code>Cargo.lock</code> file see the exact version the resolver picked for you code:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Cargo.lock file
...
[[package]]
name = &quot;nix&quot;
version = &quot;0.17.0&quot;
...
</code></pre>
<h3 id="patching-dependency-with-a-github-version"><a class="zola-anchor" href="#patching-dependency-with-a-github-version" aria-label="Anchor link for: patching-dependency-with-a-github-version">ðŸ”—</a>Patching Dependency With a Github Version</h3>
<p>We can instead push modified dependency to github and have <code>cargo patch</code> use this version. On <code>cargo build</code>, cargo will automatically clone the source code from the master branch of my GitHub repository:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Your Cargo.toml
# ...

[dependencies]
nix = &quot;0.17&quot;
libc = &quot;0.2&quot;

[patch.crates-io]
nix = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;nix&quot; }
</code></pre>
<p>This tells cargo to use my version on the nix library, living under my GitHub username: <code>gatowololo/nix</code>. This presents its own set of problems, if we update <code>gatowololo/nix</code>'s master branch what will happen next time someone does <code>cargo build</code>? This is once again handled by the <code>Cargo.lock</code> file. The first time you <code>cargo build</code> with a patch manifest section cargo will write relevant information to the projects <code>Cargo.lock</code> file:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml">[[patch.unused]]
name = &quot;nix&quot;
version = &quot;0.17.0&quot;
source = &quot;git+https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;nix#3b8180c430fe838e4fd71b83e5f92db6386e5c57&quot;
</code></pre>
<p>Here we can see Cargo specifies the commit hash <code>3b8180c</code> which was used for patching as well as the URL for my version of Nix. If you are ever unsure if Cargo is using your patch, you can check here.</p>
<h4 id="using-different-branch"><a class="zola-anchor" href="#using-different-branch" aria-label="Anchor link for: using-different-branch">ðŸ”—</a>Using Different Branch</h4>
<p>By default <code>Cargo</code> pulls your code from the default branch, you can specify what branch to use as well:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml">[patch.crates-io]
nix = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;nix&quot;, branch=&quot;my-dev&quot; }
</code></pre>
<h4 id="specifying-commit-hash"><a class="zola-anchor" href="#specifying-commit-hash" aria-label="Anchor link for: specifying-commit-hash">ðŸ”—</a>Specifying Commit Hash</h4>
<p>You can also specify the commit to use:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml">[patch.crates-io]
nix = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;nix&quot;, rev=&quot;3b8180c&quot; }
</code></pre>
<h4 id="crab-sharp-edge-cargo-lock-and-version-control"><a class="zola-anchor" href="#crab-sharp-edge-cargo-lock-and-version-control" aria-label="Anchor link for: crab-sharp-edge-cargo-lock-and-version-control">ðŸ”—</a>ðŸ¦€ Sharp Edge: <code>Cargo.lock</code> and Version Control</h4>
<p>If your <code>my-crate</code> project <a href="https://doc.rust-lang.org/cargo/faq.html#why-do-binaries-have-cargolock-in-version-control-but-not-libraries">does not check <code>Cargo.lock</code> into version control</a>, <code>cargo build</code> will use the latest version on <code>master</code>. This irreproducible behavior is probably <strong>not</strong> what you want!</p>
<h3 id="patching-github-dependencies"><a class="zola-anchor" href="#patching-github-dependencies" aria-label="Anchor link for: patching-github-dependencies">ðŸ”—</a>Patching GitHub Dependencies</h3>
<p>Not all cargo crates live on crates.io. What happens when a dependency is itself specified as a git dependency? Like:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Cargo.toml
# ...
[dependencies]
servo-media = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;servo&#x2F;media&quot; }
</code></pre>
<p>We can patch such a dependency like so:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Cargo.toml
# ...
[patch.&quot;https:&#x2F;&#x2F;github.com&#x2F;servo&#x2F;media&quot;]
servo-media = {git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;servo-media&quot;}
</code></pre>
<p>We specify the URL in as <code>[patch.&quot;URL&quot;]</code>. This patch replaces <code>servo/media</code> with my own version <code>gatowololo/servo-media</code> on Github.</p>
<h4 id="crab-sharp-edge-patching-with-different-branch"><a class="zola-anchor" href="#crab-sharp-edge-patching-with-different-branch" aria-label="Anchor link for: crab-sharp-edge-patching-with-different-branch">ðŸ”—</a>ðŸ¦€ Sharp Edge: Patching with Different Branch</h4>
<p>What happens if you want to patch a git dependency using the same repository but a different branch? Like so:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Cargo.toml
# ...
[dependencies]
rr_channel = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;rr_channel&quot;}
# ...
[patch.&quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;rr_channel&quot;]
rr_channel = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;rr_channel&quot;, branch = &quot;servo_development&quot;}
</code></pre>
<p>Here we attempt to test a change on our <code>servo_development</code> branch in the same GitHub repository. When running <code>cargo build</code> we get the following error however:</p>
<pre><code>error: failed to resolve patches for `https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;rr_channel`

Caused by:
  patch for `rr_channel` in `https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;rr_channel` points to the same source, but patches must point to different sources
</code></pre>
<p>This is a known <a href="https://github.com/rust-lang/cargo/issues/5478">issue</a>. The current workaround is to add extra '/' to the URL of the patch so Cargo thinks it is the patch points to a different source but resolves to the same path:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml"># Cargo.toml
# ...
[patch.&quot;https:&#x2F;&#x2F;github.com&#x2F;gatowololo&#x2F;rr_channel&quot;]
# Notice extra &#x27;&#x2F;&#x27; on URL.
rr_channel = { git = &quot;https:&#x2F;&#x2F;&#x2F;github.com&#x2F;&#x2F;gatoWololo&#x2F;rr_channel&quot;, branch = &quot;servo_development&quot;}
</code></pre>
<p>This works but creates a new foot gun, see <a href="https://gatowololo.github.io/blog/cargo-patch/#crab-sharp-edge-git-dependency-with-extra">Sharp Edge: Git Dependency with Extra <code>/</code></a> below.</p>
<h4 id="crab-sharp-edge-virtual-workspaces"><a class="zola-anchor" href="#crab-sharp-edge-virtual-workspaces" aria-label="Anchor link for: crab-sharp-edge-virtual-workspaces">ðŸ”—</a>ðŸ¦€ Sharp Edge: Virtual Workspaces</h4>
<p>Cargo enables crates to be broken down into multiple crates using <a href="https://doc.rust-lang.org/book/ch14-03-cargo-workspaces.html">Cargo Workspaces</a>. Patching crates with workspaces is slightly different.</p>
<p>Patching with the target being a git source is straightforward enough. Notice servo-media-gstreamer and servo-media-dummy are (sub?? TODO ) crates in servo media:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml">[patch.&quot;https:&#x2F;&#x2F;github.com&#x2F;servo&#x2F;media&quot;]
servo-media = {git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;servo-media&quot;}
servo-media-gstreamer = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;servo-media&quot;}
servo-media-dummy = { git = &quot;https:&#x2F;&#x2F;github.com&#x2F;gatoWololo&#x2F;servo-media&quot;}
</code></pre>
<p>The behavior for patching <code>servo-media</code> with a local copy is different. When patching subcrates you must specify the path not to the room of the package, but to the subcrate:</p>
<pre data-lang="toml" class="language-toml "><code class="language-toml" data-lang="toml">[patch.&quot;https:&#x2F;&#x2F;github.com&#x2F;servo&#x2F;media&quot;]
servo-media = {path = &quot;..&#x2F;media&#x2F;servo-media&quot;}
servo-media-gstreamer = {path = &quot;..&#x2F;media&#x2F;backends&#x2F;gstreamer&quot;}
servo-media-dummy = { path = &quot;..&#x2F;media&#x2F;backends&#x2F;dummy&quot;}
</code></pre>
<h4 id="crab-sharp-edge-git-dependency-with-extra"><a class="zola-anchor" href="#crab-sharp-edge-git-dependency-with-extra" aria-label="Anchor link for: crab-sharp-edge-git-dependency-with-extra">ðŸ”—</a>ðŸ¦€ Sharp Edge: Git Dependency with Extra <code>/</code></h4>
<p>Using the extra <code>/</code> trick as shown above (TODO link) is helpful but can lead to a different error.</p>
<h4 id="footnotes"><a class="zola-anchor" href="#footnotes" aria-label="Anchor link for: footnotes">ðŸ”—</a>Footnotes</h4>
<p><sup class="footnote-reference"><a href="#1">1</a></sup> One common feedback about the Rust ecosystem is the lack of intermediate and advanced documentation and blogs. I have several half-finished blogs because they were ambitious, so this blog will assume familiarity with <code>Cargo</code>, the <code>Cargo.toml</code> file, and roughly how Rust deals with dependencies. In the future I may come back and do a <code>Cargo.toml</code> and <code>Cargo.lock</code> in depth blog.</p>
<p><sup class="footnote-reference"><a href="#2">2</a></sup> <a href="https://crates.io/">crates.io</a> is Rust's offical crate repository, and all crate dependencies are all downloaded from here by default on <code>cargo build</code>.</p>
<p><sup class="footnote-reference"><a href="#3">3</a></sup> While Cargo replace is not technically replicated. The <a href="https://doc.rust-lang.org/edition-guide/rust-2018/cargo-and-crates-io/replacing-dependencies-with-patch.html">docs</a> mention &quot;&quot;while we don't intend to deprecate or remove [replace], you should prefer [patch] in all circumstances&quot;. So you should always use Cargo patch.</p>
<p><sup class="footnote-reference"><a href="#4">4</a></sup> There is nothing stopping you from leaving the <code>[patch]</code> permanently, but it does not seem to be good practice.</p>
<p><sup class="footnote-reference"><a href="#5">5</a></sup> The structure of the <code>~/.cargo/</code> directory is unclear to me. So I omit atempting to explain this path.</p>

</div>

        </div>
    </body>

</html>
